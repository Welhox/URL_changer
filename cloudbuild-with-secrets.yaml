# Example with Secret Manager (more secure)
steps:
  # Access secrets from Secret Manager
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        gcloud secrets versions access latest --secret="database-url" > /workspace/db_url.txt
        gcloud secrets versions access latest --secret="secret-key" > /workspace/secret_key.txt
        gcloud secrets versions access latest --secret="api-key" > /workspace/api_key.txt

  # Build the Docker image
  - name: 'gcr.io/cloud-builders/docker'
    args: [
      'build', 
      '--build-arg', 'VITE_API_KEY=$$(cat /workspace/api_key.txt)',
      '-t', 'gcr.io/$PROJECT_ID/url-changer:$COMMIT_SHA',
      '.'
    ]

  # Deploy to Cloud Run with secrets
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        gcloud run deploy url-changer \
          --image gcr.io/$PROJECT_ID/url-changer:$COMMIT_SHA \
          --region us-central1 \
          --platform managed \
          --allow-unauthenticated \
          --set-env-vars ENVIRONMENT=production \
          --set-env-vars DATABASE_URL=$$(cat /workspace/db_url.txt) \
          --set-env-vars SECRET_KEY=$$(cat /workspace/secret_key.txt) \
          --set-env-vars API_KEY=$$(cat /workspace/api_key.txt)

images:
  - 'gcr.io/$PROJECT_ID/url-changer:$COMMIT_SHA'